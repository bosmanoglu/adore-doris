#!/bin/bash

unset masterLastProcessingStep firstLine lastLine firstPixel lastPixel
#check if dbowgeo is set
if [ "${rs_dbow_geo}" == "0 0 0 0" ]; then
  #if not check for rs_dbow
  if [ "${rs_dbow}" == "0 0 0 0" ]; then
   set -x
   # get a smaller dbow from master. Otherwise the resampling may fail. 
   local l0 lN p0 pN lshift pshift 
   l0=`${ADORESCR}/readRes.sh ${m_resfile} crop "First_line"`
   lN=`${ADORESCR}/readRes.sh ${m_resfile} crop "Last_line"`
   p0=`${ADORESCR}/readRes.sh ${m_resfile} crop "First_pixel"`
   pN=`${ADORESCR}/readRes.sh ${m_resfile} crop "Last_pixel"`

   lshift=`${ADORESCR}/readRes.sh ${i_resfile} coarse_correl "Coarse_correlation_translation_lines"`
   pshift=`${ADORESCR}/readRes.sh ${i_resfile} coarse_correl "Coarse_correlation_translation_pixels"`
   if [ ${lshift} -lt 0 ]; then 
     l0=$((${l0}-${lshift}+${rs_az_buffer}))
     lN=$((${lN}-${rs_az_buffer}))
   else 
     l0=$((${l0}+${rs_az_buffer}))
     lN=$((${lN}-${lshift}-${rs_az_buffer}))
   fi
   if [ ${pshift} -lt 0 ]; then
     p0=$((${p0}-${pshift}+${rs_rg_buffer}))
     pN=$((${pN}-${rs_rg_buffer}))
   else
     p0=$((${p0}+${rs_rg_buffer}))
     pN=$((${pN}-${pshift}-${rs_rg_buffer}))
   fi
   rs_dbow="${l0} ${lN} ${p0} ${pN}"
   set +x
  fi
fi

pp ${dorisProcess}

# remove undefined settings from .drs file so that doris handles it
# automatically

if [ "${rs_dbow_geo}" == "0 0 0 0" ]; then
  grep -i -v -w "rs_dbow_geo" ${outputFolder}/${dorisProcess}.drs > ${outputFolder}/${dorisProcess}.drs.new
  mv ${outputFolder}/${dorisProcess}.drs.new ${outputFolder}/${dorisProcess}.drs
fi

### This is actually not necessary. if dbow_geo exists this is omitted. If dbow_geo is all zeros then 
### first part of the code sets rs_dbow anyway...
if [ "${rs_dbow}" == "0 0 0 0" ]; then
# get a smaller dbow from master. Otherwise the resampling may fail. 
  grep -i -v -w "rs_dbow" ${outputFolder}/${dorisProcess}.drs > ${outputFolder}/${dorisProcess}.drs.new
  mv ${outputFolder}/${dorisProcess}.drs.new ${outputFolder}/${dorisProcess}.drs
fi


#run doris
doris ${outputFolder}/${dorisProcess}.drs
[ $? -eq 0 ] && echo "${dorisProcess}: SUCCESS"
